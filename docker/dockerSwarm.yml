---

- name: Install docker swarm on CentOS 7
  hosts: docker
  remote_user: root
  become: yes
  tasks:
########################### Common Packages ################################

  - name: Install common packages
    yum: name={{ item }} state=latest
    with_items:
          - yum-utils
          - device-mapper-persistent-data
          - lvm2
          - iptables
    ignore_errors: yes

############################# Firewall Rules ################################

  - name: Add iptable configuration file
    template:
      src: files/iptables.j2
      dest: /etc/sysconfig/iptables
      owner: root
      group: root
      mode: 0644
    ignore_errors: yes

  - name: Configure persistent Port Forwarding to Docker
    template:
      src: files/sysctl.conf.j2
      dest: /etc/sysctl.conf
      owner: root
      group: root
      mode: 0644
    ignore_errors: yes

  - name: Reload IPtables
    service: name={{item}} daemon_reload=yes
    with_items:
      - iptables
    ignore_errors: yes

############################# Install Docker #################################

  - name: Get docker repository
    shell: yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
    ignore_errors: yes

  - name: Install Docker CE
    shell: yum install -y docker-ce
    ignore_errors: yes

  - name: Docker info check
    shell: docker container --help && docker --version
    ignore_errors: yes

  - name: Enable Docker service
    service: name={{item}} enabled=yes
    with_items:
      - docker
    ignore_errors: yes

  - name: Start docker service
    service: name={{item}} state=started
    with_items:
      - docker
    ignore_errors: yes

  - name: Docker info check
    shell: docker info

